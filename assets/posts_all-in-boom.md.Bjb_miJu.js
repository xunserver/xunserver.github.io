import{_ as l,c as i,o as e,ah as t}from"./chunks/framework.BurO9VyR.js";const u=JSON.parse('{"title":"all-in-boom","description":null,"frontmatter":{"title":"all-in-boom","comments":true,"hide":false,"abbrlink":"ff614c6c","date":"2022-10-22T09:49:50.000Z","updated":"2022-10-22T09:49:50.000Z","tags":null,"categories":null,"description":null},"headers":[],"relativePath":"posts/all-in-boom.md","filePath":"posts/all-in-boom.md"}'),s={name:"posts/all-in-boom.md"};function o(n,a,r,h,d,m){return e(),i("div",null,a[0]||(a[0]=[t('<h2 id="介绍" tabindex="-1">介绍 <a class="header-anchor" href="#介绍" aria-label="Permalink to &quot;介绍&quot;">​</a></h2><p>最近在折腾家里的网路设备，原因娃要出生了， 搞一个好点的存储设备来保存娃的照片视频等，顺便把屋里的设备升级一下。 先介绍下现在屋里的网络布局</p><h3 id="光猫" tabindex="-1">光猫 <a class="header-anchor" href="#光猫" aria-label="Permalink to &quot;光猫&quot;">​</a></h3><p>光猫买的是华为的B610-4E替换了运营商送的光猫，比较稳定而且可以自由改桥接。该光猫有4个千兆口，规划如下</p><ul><li>eth0: 网络桥接端口，桥接光猫和软路由(二层端口)</li><li>eth1: 光猫管理端口，192.168.2.4（三层端口）</li><li>eth2: 备用端口，如果路由器故障，通过光猫拨号</li><li>eth3: 电视桥接端口，同网络桥接端口</li></ul><p>需要注意的是，华为的三层lan不是桥接接口， 不能勾选多个三层lan。路由器配置页面的使能啥啥的，就是是否启用。 wan口配置三个接口</p><ol><li>桥接模式lan1，路由器拨号</li><li>桥接模式lan4，电视拨号</li><li>路由模式lan3，但是不启用</li></ol><h3 id="软路由" tabindex="-1">软路由 <a class="header-anchor" href="#软路由" aria-label="Permalink to &quot;软路由&quot;">​</a></h3><p>接下来是软路由的选购。i255 2.5G网口虽然更便宜，但是有断流问题，二来屋里交换机都是千兆，用不上。N5105发热过大，不适合放在弱电箱。单内存的机器在esxi下，装两个虚拟机内存就不够。没法all-in-boom。</p><p>选了倍控家的j4125 4*i211千兆 双内存的这款机器两个内存累计最多16G，j4125 4C4T 2.0Ghz。还支持一个2.5寸的硬盘，刚好能够满足路由器 + homeassistant + nas的需求。网口刚好做以下规划</p><ul><li>eth0: esxi 虚拟路由器的接口 （上面桥接了hass 和 esxi 的管理端口）</li><li>eth1: 连接光猫桥接的lan1，作为路由器的wan口</li><li>eth2: 路由器的lan口</li><li>eth3: 直通给nas</li></ul><h3 id="交换机" tabindex="-1">交换机 <a class="header-anchor" href="#交换机" aria-label="Permalink to &quot;交换机&quot;">​</a></h3><p>弱电箱: 里面有7个通向客厅房间的网口，电视柜两个，客厅电话线（被我替换成了网线）1个，三个房间4个（主卧两个）。光猫3个（除了光猫的桥接口连接到软路由上）， nas和esxi加起来一个，电视桥接口一个。需要一个16口的交换机。把三个设备塞到一起还是需要费点时间。</p><p>书房: 有个双路的x99机器，一共6个网口。安转的esxi虚拟了三个虚拟机，作为平常生产工具用。直通了3个网口。由于书房只有一个网口，也需要一个交换机来扩展网口，其实可以用路由器的ap模式来扩展，但是我只有三个网口的小米路由器R3G。搞了一个8口千兆交换机</p><p>客厅中电视柜: 机顶盒 _ 1、switch _ 1、摄像头 _ 2、小米AX 6000 _ 1。之前电视柜还有个做nas的主机(升级后不需要)。 也是需要一个8口千兆交换机</p><h3 id="ap部分" tabindex="-1">AP部分 <a class="header-anchor" href="#ap部分" aria-label="Permalink to &quot;AP部分&quot;">​</a></h3><ul><li>客厅AX6000使用的小米默认固件开启AP模式，5G网络满足几个笔记本和手机打游戏需求。2.4G 网络用于物联网设备的接入、包括窗帘、客厅灯、电脑开机卡、万能红外遥控器、小米多模网关、小爱音响、斐讯音响、门锁、客厅空调、斐讯空气净化器、厨房的冰箱、电饭煲、洗衣机、加湿器还有各种涂鸦智能的开关（设备就是这么多）</li><li>卧室中关门信号就弱，两个卧室各安转了一个小米R3G（便宜而且体积不占地方），刷了breed安装了H大固件，开启AP模式，同时将发射功率调整到原来的20%。卧室中路由器通过交换机模式满足电视的上网，通过2.4G支持卧室中的物联网设备(遥控器、床头小爱音响、房间灯、空调等)，5G用于平常上网。</li></ul><p>全屋漫游问题，由于小米的固件是在太垃圾，而且试用过小米的漫游方案，确实效果一般，bug还多。采用了弱信号剔除和一致性SSID的方案，把全屋各个WIFI名字设置成一致。各个AP降低放射功率，开启弱信号替换。弱信号的方案成本较低。</p><h3 id="nas-和-homeassistant" tabindex="-1">NAS 和 HomeAssistant <a class="header-anchor" href="#nas-和-homeassistant" aria-label="Permalink to &quot;NAS 和 HomeAssistant&quot;">​</a></h3><p>NAS采用的群晖方案，对于小白来说比较简单。j4125中直接虚拟一个，然后RDM直通硬盘<br> HomeAssistant使用官方提供的虚拟机镜像，直接安装。</p><h3 id="各种物联网设备" tabindex="-1">各种物联网设备 <a class="header-anchor" href="#各种物联网设备" aria-label="Permalink to &quot;各种物联网设备&quot;">​</a></h3><ul><li>小米系列 <ul><li>小米触屏音响必须要买，家里的语音交互、TTS、主动问询等功能都依赖该设备。主卧放一个小个、客厅放一个打的当电子相框用。</li><li>小米多模网关、小米系的传感器依赖</li><li>小米传感器: 光照传感器（配合窗帘自动开关），人体传感器、米家蓝牙夜灯（带人体传感器和光照传感器）、门窗传感器，温湿度传感器</li><li>小米家电: 小米空调、小米电视、小米洗衣机、小米冰箱、小米扫地机器人、小米门锁。</li></ul></li><li>涂鸦系 <ul><li>涂鸦系的红外万能遥控器，PDD 19块钱包邮，多买几个、控制老电视和其他牌子的空调必备。</li><li>涂鸦系的wifi开关 19包邮，多买几个</li><li>涂鸦系的射频遥控器 淘宝69一个</li></ul></li><li>HomeAssistant论坛 <ul><li>窗帘电机 298，支持mqtt、html、tcp等多个协议、通过巴法云可以接入小爱。</li><li>各种开关，把墙上的开关内都置换上。也是支持ha接入。</li></ul></li><li>其他 <ul><li>斐讯N1，刷YYF看电视</li><li>斐讯R1，安转DLAN 放会儿歌</li><li>斐讯m1，空气质量检测，配置ha使用</li><li>各类摄像头，摄像头推荐雄迈（记得关闭外网访问），能够接入ha，小米系的没法接入。</li><li>开机卡，用于打开电脑和关闭电脑。</li></ul></li></ul><h2 id="安装" tabindex="-1">安装 <a class="header-anchor" href="#安装" aria-label="Permalink to &quot;安装&quot;">​</a></h2><h3 id="j4125-安装esxi" tabindex="-1">j4125 安装esxi <a class="header-anchor" href="#j4125-安装esxi" aria-label="Permalink to &quot;j4125 安装esxi&quot;">​</a></h3><p>倍控家j4125 + 4 * i211网卡+双内存版本准系统670R。如果对断流能够忍耐的也可选2.5G，准系统550R。准系统需要笔记本内存条DDR4L，最高2666MHZ，单个内存最多支持8G。闲鱼买大概120一根，建议买三星。还需要一个msata的硬盘，最小准备一个64G的盘。</p><p>需要直通的硬盘记得先在PE上面把分区表删除掉保存，修改分区表格式和msata盘一致。</p><p>硬件安装步骤如下</p><ol><li>拆开主机外壳，找到内存插槽，内存条上有个缺口，缺口左右一长一短。斜向上对准主板插口，擦入后，按一下，听见咔一声即可。拆内存时，先把两边的卡扣向外拉一下，内存就自动弹出来了。</li><li>主板上有两个接口和msata硬盘的接口长得一样，注意看有一个写了个WIFI，安装到没写wifi的接口上，先把接口上的固定硬盘的螺丝取下来。插入硬盘后安装螺丝固定。</li><li>安装机械硬盘，先使用送的sata转接线连接硬盘，这个比较简单，然后找主板上的sata接口和供电接口，供电接口是4针的，sata接口长的和硬盘的上接口一致。连接好后，把硬盘固定到主机的背板上。背板是要扣回主机的，硬盘要安装在背板里面，塞进主机。</li></ol><p>系统安装esxi比较稳定，我连续100天没关机。自行官网下载esxi镜像，或者在恩山论坛x86专区下载别人编译好的镜像。</p><ol><li>找一个U盘，最好16G，usb3.0。使用软碟通写入镜像到U盘，或者使用balenaEtcher软件写盘</li><li>U盘插入倍控，连接好键盘。插上电源线后狂按F11进入bios界面。先恢bios到默认设置，检查下VT-D是否开启。选择U盘启动</li><li>进入esxi加载页面后，会有5S等待时间，5S内按下shift + o 键编辑安转设置，输入空格autoPartitionOSDataSize=8192（这一步必要的，用于调整虚拟闪存大小，错过了关机重来）。然后回车进入安装界面，然后根据提示一路默认，系统记得安装到msata盘上。</li><li>系统安装好会需要在控制台调整管理端口，开机进入系统后，按F2进入网络配置，选择network adaptor，用一根网线连接电脑和主机的eth0口，观察哪个控制台哪个是connect的，选择这个网口作为管理端口。ESC退出后会重启网络端口，在进入ipv4配置页面，将管理端口的IP设置为192.168.2.16，网管设置为192.168.2.2 掩码 255.255.255.0，保存后退出。</li><li>电脑网线连接eth0的网口，电脑设置静态IP为192.168.2.21 掩码 255.255.255.0 网关192.168.2.2。</li><li>设置好电脑IP后，登录<a href="https://192.168.2.xn--16esxi-4l2j110uwkojw1cj1t" target="_blank" rel="noreferrer">https://192.168.2.16进入esxi管理页</a>。</li></ol><h3 id="esxi-直通切换" tabindex="-1">esxi 直通切换 <a class="header-anchor" href="#esxi-直通切换" aria-label="Permalink to &quot;esxi 直通切换&quot;">​</a></h3><p>安装好esxi系统后，首先规划好网口，按照先前介绍的来规划，将eth1 eth2 eth3 切换成直通。按照下图来切换</p><h3 id="安装openwrt" tabindex="-1">安装openwrt <a class="header-anchor" href="#安装openwrt" aria-label="Permalink to &quot;安装openwrt&quot;">​</a></h3><ol><li>恩山下载任意的x86镜像。一般镜像都有EFI和不带EFI的进项，选择带有EFI字样镜像。下载后解压成.img格式为止</li><li>安装写盘工具写虚拟硬盘，百度<code>starwindconverter官网</code>, 随意填写些信息开始下载。根据提示开始转换，local file =&gt; localfile =&gt; vmdk =&gt; esxi server img =&gt; preallocat。一定要选择预分配，没必要选灵活增长。</li><li>esxi创建openwrt虚拟机，兼容性选择最新的那个(7.0 U2)，系统类型选择linux, linux5.x 64位 或则更高。</li><li>储存选择默认，在下一步都要删除的。</li><li>下一步硬件配置中把所有的设备删除干净，存储、usb和控制器都不要。删除后保存创建虚拟机，路由器CPU 2核心，单插槽两个2核心，内存选2G。不要开机</li><li>重新编辑刚才创建好的虚拟机添加硬盘，选择已有的硬盘，在弹出页中将刚才在用starwindconverter转换好的两个vmdk文件上传，并选择。</li><li>添加直通的两个网口，点击添加其他设备，添加PCI设备，选择需要直通的网卡。保存后退出，不要开机</li><li>开启esxi的ssh访问，然后电脑上ssh root@192.168.2.16ssh连接上esxi宿主机。使用vmkfstools 对vmdk文件进行扩容 vmkdstools -X 2G /vmfs/volumns/datastore1/router/xxxx.vmdk，一般2G足够应付后面的需求了。</li><li>再到网页编辑虚拟机选择，引导默认取消安全引导，使用EFI引导。</li><li>开机，进入到正常的跑代码openwrt安装完成</li></ol><h3 id="x86路由器-系统配置" tabindex="-1">x86路由器 系统配置 <a class="header-anchor" href="#x86路由器-系统配置" aria-label="Permalink to &quot;x86路由器 系统配置&quot;">​</a></h3><ol><li>系统安装完成后，电脑网线在eth1、eth2刚才直通给openwrt网口上来回试，如果哪个网口能正常分配IP，表示这个网口是lan口（注意先把网口静态地址设置为DHCP）。</li><li>连接上lan口，根据网关地址找到openwrt的管理地址。根据自己的喜好调整lan配置，我一般习惯把lan口管理地址设置为192.168.2.2，同时设置DHCP 地址为192.168.2.100 ~ 192.168.2.240。192.168.2.100 之前作为屋里设备的静态地址，后面作为那些无关设备的动态地址。</li><li>配置wan口拨号，找运营商要个拨号账密，前提是光猫改了桥接才能使用。光猫改桥接找安装宽带的师傅要个超级密码，登录光猫后删除TR69端口，然后每个页面的都拍照备份一次就可以随意折腾了。</li><li>配置好wan口，lan口就可以替换原有的上网设备了。 光猫桥接口连接wan口，openwrtlan口连接原来的路由器的lan（使原有的路由变成一个AP交换机），先临时这么用</li></ol><p>安装x86路由器的原因是里面有很多固件，可以自由折腾，比如我的就是fast.com测试就有1.2GBPS，还安转了DDNSTO，在外面随时网页连接屋里的设备，还有NPS和zerotier。有了这个路由器，屋里的ATV随时随地可以看YouTube，检索内容也更快。</p><h3 id="安装dsm" tabindex="-1">安装DSM <a class="header-anchor" href="#安装dsm" aria-label="Permalink to &quot;安装DSM&quot;">​</a></h3><p>DSM大致和上面的openwrt差不多，把网上下载的好的img镜像转换成vmdk，网上img镜像也只是一个引导镜像，不需要扩容，nas需要的大流量传输，配置好直通网卡。同样是删除所有其他的设备，只添加一个sata控制器。硬盘的话添加转换的镜像，然后需要到ssh中配置RDM直通，到设备管理器中查询需要直通的硬盘ID，vmkfstools -Z /vmfs/disks/xxxx /vmfs/volunms/datastore1/xxx.vmdk。再在虚拟配置中添加这个vmdk硬盘。 需要注意的是添加的vmdk文件都需要放在sata控制器上，同时添加引导文件在前，直通硬盘在后。同时也别忘了取消EFI安全引导。</p><p>正常开机后，注意选择sata引导，等1分钟后，到路由器的设备列表中查找是否存在dsm设备的获取到IP。浏览器输入<a href="http://xn--IP-qh5cn6dlx7fgtq:5000" target="_blank" rel="noreferrer">http://获取到的IP:5000</a> 进入dsm安装页面。按照提示上传pat文件，按照提示格式化第二个硬盘，等待10分钟后DSM安装完成。</p><h3 id="安装homeassistant" tabindex="-1">安装HomeAssistant <a class="header-anchor" href="#安装homeassistant" aria-label="Permalink to &quot;安装HomeAssistant&quot;">​</a></h3>',41)]))}const x=l(s,[["render",o]]);export{u as __pageData,x as default};
